 with revenue_usd as(
select sp.continent,
  sum(p.price) as revenue,
  sum(case when device = 'mobile' then p.price end) as revenue_from_mobile,
  sum(case when device = 'desktop' then p.price end) as revenue_from_dekstop,
  SUM (price) / SUM (SUM (price)) OVER () * 100 AS percent_revenue_from_total
  from `DA.order` o
  join `DA.product` p
  on o.item_id = p.item_id
  join `DA.session_params` sp
  on o.ga_session_id = sp.ga_session_id
  group by sp.continent),
  counts as (select
  sp.continent,
  count(acs.account_id) as account_cnt,
  count(case when ac.is_verified=1 then ac.id end) as verified_acc_cnt
  from `DA.session_params`  sp
  join `DA.account_session` acs  
  on sp.ga_session_id = acs.ga_session_id
  join `DA.account` ac
  on acs.account_id = ac.id
  group by sp.continent),
  cnts as (
  select continent,
  count(sp.ga_session_id) as session_cnt
  from `DA.session_params` sp
  group by continent)
  select ru.continent,
  ru.revenue,
  ru.revenue_from_mobile,
  ru.percent_revenue_from_total,
  cn.account_cnt,
  cn.verified_acc_cnt,
  cnts.session_cnt
  from counts cn
  left join revenue_usd ru
  on cn.continent = ru.continent
  left join cnts
  on cn.continent = cnts.continent
